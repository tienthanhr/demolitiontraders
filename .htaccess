# ============================================================================
# DEMOLITION TRADERS - ROOT MOD REWRITE CONFIGURATION
# ============================================================================

# Rewrite engine on
RewriteEngine On

# Ensure DirectoryIndex points to the correct local index
DirectoryIndex frontend/user/index.php index.php index.html

# ============================================================================
# ENVIRONMENT DETECTION & BASE URL
# ============================================================================

# Auto-detect environment based on HTTP_HOST
# Sets BASE variable: /demolitiontraders/ for localhost, / for production
RewriteCond %{HTTP_HOST} ^localhost(:[0-9]+)?$ [NC,OR]
RewriteCond %{HTTP_HOST} ^127\.0\.0\.1(:[0-9]+)?$ [NC]
RewriteRule .* - [E=BASE:/demolitiontraders]

RewriteCond %{HTTP_HOST} !^localhost$ [NC]
RewriteCond %{HTTP_HOST} !^127\.0\.0\.1$ [NC]
RewriteRule .* - [E=BASE:]

# ============================================================================
# SECURITY & HEADERS
# ============================================================================

# Prevent directory listing
Options -Indexes

# Prevent access to hidden files
RewriteRule "^\." - [F,L]

# Block access to sensitive files
RewriteRule "^web\.config$" - [F,L]
RewriteRule "^\.git" - [F,L]
RewriteRule "^\.env" - [F,L]

# Block server-status
RewriteRule "^server-status/?$" - [F,L]

# Security Headers
<IfModule mod_headers.c>
    # Content Security Policy (CSP) - Allow unsafe for inline styles/scripts (adjust as needed)
    Header set Content-Security-Policy "default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data:; font-src 'self' https: data:;"
    
    # Prevent Clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME-type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header set Referrer-Policy "no-referrer-when-downgrade"
    
    # HSTS - Only on HTTPS (production only)
    Header set Strict-Transport-Security "max-age=63072000; includeSubDomains" env=HTTPS
    
    # Permissions Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ============================================================================
# STATIC FILES & ASSETS (Allow direct access)
# ============================================================================

# Allow direct access to existing files
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Allow direct access to existing directories
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ============================================================================
# API ROUTES
# ============================================================================

# Route /api/... to backend/api/index.php with query string
RewriteRule ^api/(.*)$ %{ENV:BASE}/backend/api/index.php?request=$1 [QSA,L]

# Allow direct backend API file access (legacy endpoints)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^backend/api/.*\.php$ - [L]

# ============================================================================
# ADMIN ROUTES (/admin/... → admin/...)
# ============================================================================

# /admin → /admin/index.php
RewriteRule ^admin/?$ %{ENV:BASE}/admin/index.php [L]
RewriteRule ^site-admin/?$ site-admin.php [L]

# /admin-login → /frontend/admin-login.php
RewriteRule ^admin-login/?$ %{ENV:BASE}/frontend/admin-login.php [L]

# /admin/sell-to-us → /admin/sell-to-us.php
RewriteRule ^admin/sell-to-us/?$ %{ENV:BASE}/admin/sell-to-us.php [L]

# /admin/wanted-listings → /admin/wanted-listings.php
RewriteRule ^admin/wanted-listings/?$ %{ENV:BASE}/admin/wanted-listings.php [L]

# /admin/contact-messages → /admin/contact-messages.php
RewriteRule ^admin/contact-messages/?$ %{ENV:BASE}/admin/contact-messages.php [L]

# /admin/* → /admin/*
RewriteRule ^admin/(.+)$ %{ENV:BASE}/admin/$1 [L]
RewriteRule ^site-admin/(.+)$ site-admin.php?path=$1 [L,QSA]

# Alternative admin path to avoid conflicts (site-admin)
RewriteRule ^site-admin/?$ %{ENV:BASE}/admin/index.php [L]
RewriteRule ^site-admin/(.+)$ %{ENV:BASE}/admin/$1 [L]

# ============================================================================
# USER PAGES & PUBLIC ROUTES
# ============================================================================

# Root / → /frontend/user/index.php
RewriteRule ^$ %{ENV:BASE}/frontend/user/index.php [L]

# Main user pages
RewriteRule ^index/?$ %{ENV:BASE}/frontend/user/index.php [L]
RewriteRule ^shop/?$ %{ENV:BASE}/frontend/user/shop.php [QSA,L]
RewriteRule ^product-detail/?$ %{ENV:BASE}/frontend/user/product-detail.php [QSA,L]
RewriteRule ^cart/?$ %{ENV:BASE}/frontend/user/cart.php [L]
RewriteRule ^checkout/?$ %{ENV:BASE}/frontend/user/checkout.php [L]
RewriteRule ^wishlist/?$ %{ENV:BASE}/frontend/user/wishlist.php [L]

# Authentication pages
RewriteRule ^login/?$ %{ENV:BASE}/frontend/user/login.php [L]
RewriteRule ^reset-password/?$ %{ENV:BASE}/frontend/user/reset-password.php [L]

# User account pages
RewriteRule ^profile/?$ %{ENV:BASE}/frontend/user/profile.php [L]
RewriteRule ^order-detail/?$ %{ENV:BASE}/frontend/user/order-detail.php [QSA,L]

# Information pages
RewriteRule ^about/?$ %{ENV:BASE}/frontend/user/about.php [L]
RewriteRule ^contact/?$ %{ENV:BASE}/frontend/user/contact.php [L]
RewriteRule ^faqs/?$ %{ENV:BASE}/frontend/user/faqs.php [L]
RewriteRule ^terms/?$ %{ENV:BASE}/frontend/user/terms.php [L]
RewriteRule ^staff/?$ %{ENV:BASE}/frontend/user/staff.php [L]

# Business pages
RewriteRule ^cabins/?$ %{ENV:BASE}/frontend/user/cabins.php [L]
RewriteRule ^sell-to-us/?$ %{ENV:BASE}/frontend/user/sell-to-us.php [L]
RewriteRule ^wanted-listing/?$ %{ENV:BASE}/frontend/user/wanted-listing.php [L]

# ============================================================================
# LOGOUT & SPECIAL ROUTES
# ============================================================================

# Allow direct logout access
RewriteRule ^logout\.php$ - [L]

# ============================================================================
# CATCH-ALL & SECURITY
# ============================================================================

# Prevent direct access to frontend/user/ and frontend/admin/ directories
#RewriteRule ^frontend/(user|admin)/ - [F,L]

# Prevent direct PHP file access in frontend/ (except through rewrites)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^frontend/.*\.php$ - [F,L]
