{
    # Enable debug logs
    debug
    # Disable automatic HTTPS because Railway handles SSL termination
    auto_https off
    # Disable the admin API to prevent conflicts
    admin off
}

:{$PORT} {
    # Set root to project root
    root * .

    # Health check endpoint (bypasses PHP)
    respond /health "OK" 200

    # Basic security
    @blocked {
        path */.*
        path /backend/config/*
        path /backend/core/*
        path /backend/logs/*
        path /composer.*
        path /Dockerfile
        path /Caddyfile
        path /apache-config.conf
        path /start.sh
        path /.git/*
    }
    respond @blocked 403

    # --- Static Assets ---
    handle_path /assets/* {
        root * ./frontend/assets
        file_server
    }

    handle_path /components/* {
        root * ./frontend/components
        file_server
    }

    # --- Backend API ---
    handle_path /api/* {
        rewrite * /backend/api/index.php?request={path}&{query}
        php_fastcgi 127.0.0.1:9000 {
             env HTTPS on
             env HTTP_X_FORWARDED_PROTO https
             env X-Forwarded-Proto https
        }
    }

    # --- Admin Panel ---
    handle_path /admin/* {
        try_files /frontend/admin{path} /frontend/admin{path}.php /frontend/admin/index.php
        php_fastcgi 127.0.0.1:9000 {
             env HTTPS on
             env HTTP_X_FORWARDED_PROTO https
             env X-Forwarded-Proto https
        }
    }

    # --- Admin Login ---
    handle /admin-login {
        rewrite * /frontend/admin-login.php
        php_fastcgi 127.0.0.1:9000 {
             env HTTPS on
             env HTTP_X_FORWARDED_PROTO https
             env X-Forwarded-Proto https
        }
    }

    # --- Main Site (User) ---
    handle {
        # Rewrite root to user index
        rewrite / /frontend/user/index.php

        # Rewrite top-level PHP files to frontend/user/
        @user_pages {
            path_regexp user_page ^/([^/]+)\.php$
        }
        rewrite @user_pages /frontend/user/{re.user_page.1}.php

        # PHP handler
        @php {
            path *.php
        }
        php_fastcgi @php 127.0.0.1:9000 {
             env HTTPS on
             env HTTP_X_FORWARDED_PROTO https
             env X-Forwarded-Proto https
        }

        # Fallback to static files
        file_server
    }
}
